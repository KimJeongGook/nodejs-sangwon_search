var nodeExcel = require('excel-export');

var db = require("../../DB_config.js").connect;

exports.listener=function(request, response){
	console.log("********************* excel_download_8.js enter *********************");
	var sql = "";	
	
    var conf ={};
    
	//a=[i+1, mem_name, mem_phone, mem_position, mem_birth, mem_join, mem_ness_name, mem_ness_phone, mem_work_duty, mem_work_phone, mem_address_work, mem_home_phone, mem_address_home];
    conf.cols = [{
        caption:'번호',
        type:'number',
        width:8
    },{
        caption:'구 분',
        captionStyleIndex: 1,        
        type:'string',
        beforeCellWrite:function(row, cellData){
                         if(cellData==null)
             return '';
            else
             return cellData.toUpperCase();
        }
        , width:15          
    },{
        caption:'회사명',
        captionStyleIndex: 1,        
        type:'string',
        beforeCellWrite:function(row, cellData){
                         if(cellData==null)
             return '';
            else
             return cellData.toUpperCase();
        }
        , width:25
    },{
        caption:'대표자',
        captionStyleIndex: 1,        
        type:'string',
        beforeCellWrite:function(row, cellData){
                         if(cellData==null)
             return '';
            else
             return cellData.toUpperCase();
        }
        , width:40    
    },{
        caption:'홈페이지',
        captionStyleIndex: 1,        
        type:'string',
        beforeCellWrite:function(row, cellData){
                         if(cellData==null)
             return '';
            else
             return cellData.toUpperCase();
        }
        , width:30    
    },{
        caption:'업종 및 주요제품',
        captionStyleIndex: 1,        
        type:'string',
        beforeCellWrite:function(row, cellData){
                         if(cellData==null)
             return '';
            else
             return cellData.toUpperCase();
        }
        , width:80    
    },{   
        caption:'상장일',
        captionStyleIndex: 1,        
        type:'string',
        beforeCellWrite:function(row, cellData){
                         if(cellData==null)
             return '';
            else
             return cellData.toUpperCase();
        }
        , width:15
    },{
        caption:'종목코드',
        captionStyleIndex: 1,        
        type:'string',
        beforeCellWrite:function(row, cellData){
                         if(cellData==null)
             return '';
            else
             return cellData.toUpperCase();
        }
        , width:15         
    },{
        caption:'지역',
        captionStyleIndex: 1,        
        type:'string',
        beforeCellWrite:function(row, cellData){
                         if(cellData==null)
             return '';
            else
             return cellData.toUpperCase();
        }
        , width:15         
    }];

    
    sql = "SELECT * FROM doc_8 ORDER BY idx \n";
	
	db.query(sql, function(error, results){
		 if(error){
			 //response.send(error);
		 }else{
			console.log("sql ::::::: " + sql);
			
			var arr = [];
			
			for(i=0; i<results.length; i++){
				var idx = results[i].idx;
                var division = results[i].division;                
                var company_name = results[i].company_name;
                var orgmem_name = results[i].orgmem_name;
                var homepage = results[i].homepage;
                var main_task = results[i].main_task;
                var date = results[i].date;
                var code = results[i].code;
                var area = results[i].area;
                
				a=[idx, division, company_name, orgmem_name, homepage, main_task, date, code, area];
				
				arr.push(a);
			}
			
			conf.rows = arr;
			
			var result = nodeExcel.execute(conf);

		    response.setHeader('Content-Type', 'application/vnd.openxmlformats');

		    response.setHeader("Content-Disposition", "attachment; filename=" + "sheet8.xlsx");

		    response.end(result, 'binary');
		 }		 
		 
	});
}