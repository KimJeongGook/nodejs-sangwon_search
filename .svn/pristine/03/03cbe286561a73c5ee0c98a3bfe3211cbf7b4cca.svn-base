var fs = require("fs");
var http = require("http");
var ejs = require("ejs");
var async = require("async");

var db = require("../../DB_config.js").connect;
var page_navi = require("../../../function/board_page_navi_user.js");
var layout = require("../../../function/layout.js");
var session = require("../../../function/session.js");

exports.listener=function(request, response){
	var connectorNo = session.connectorNo(request);
	
	var table = "hongbo_board";
	var file_table = "hongbo_files";		
	var strlimit = request.param("strlimit") == undefined ? 0 : request.param("strlimit");
	var endlimit = request.param("endlimit") == undefined ? 8 : request.param("endlimit");
	
	// var active = (request.param("category")==null) ? 'base' : request.param("category");
	var active = request.param("active") == "" ? 'base': request.param("active");
	var p_where = "";
	/*fs.readFile("./views/user/hongbo_board/board_list.html", "utf-8", function(error, data){
		page_navi.action('hongbo', p_where, nowPage, col_count, row_count, function(error, page_txt, page_start, page_end){*/
			var sql = "";
			switch (active) {
			case 'base':	
				sql += "select a.*, date_format(a.create_date, '%Y-%m-%d') as c_date,";
				sql +=" cast(if(a.sort = '', '9999999999', a.sort) as UNSIGNED) as brd_sort,";
				sql +=" (select ad_nm from admin where ad_id = a.create_id) as create_name, ";
				sql +=" ifnull((select c.file_dtname from "+file_table+" c where c.board_no = a.board_no and c.file_type='main'), '') as img_file_name, ";
				sql +=" ifnull(b.orgmem_name, '') as orgmem_name, ";
				sql +=" ifnull((select org_seqNo from org_seq where org_no = b.orgmem_seqNo), '') as org_leader, ";
				sql +=" ifnull((select org_seqYear from org_seq where org_no = b.orgmem_seqNo), '') as org_leader_day, ";
				sql +=" orgmem_leader_code, ";
				sql +=" (select count(*) from hongbo_board_comment c where c.board_no = a.board_no) as comment_cnt";
				sql +=" from "+table+" a left outer join orgmember b on a.orgmem_no = b.orgmem_no ";
				sql += " where a.board_id = 'hongbo' AND a.topcompany = '' or a.topcompany IS NULL OR a.topcompany = 'N'";
				sql += " order by board_no";
				sql += " limit " + strlimit +", " + endlimit;
			break;

			case 'top':
				sql += "select a.*, date_format(a.create_date, '%Y-%m-%d') as c_date,";
				sql +=" cast(if(a.sort = '', '9999999999', a.sort) as UNSIGNED) as brd_sort,";
				sql +=" (select ad_nm from admin where ad_id = a.create_id) as create_name, ";
				sql +=" ifnull((select c.file_dtname from "+file_table+" c where c.board_no = a.board_no and c.file_type='main'), '') as img_file_name, ";
				sql +=" ifnull(b.orgmem_name, '') as orgmem_name, ";
				sql +=" ifnull((select org_seqNo from org_seq where org_no = b.orgmem_seqNo), '') as org_leader, ";
				sql +=" ifnull((select org_seqYear from org_seq where org_no = b.orgmem_seqNo), '') as org_leader_day, ";
				sql +=" orgmem_leader_code, ";
				sql +=" (select count(*) from hongbo_board_comment c where c.board_no = a.board_no) as comment_cnt";
				sql +=" from "+table+" a left outer join orgmember b on a.orgmem_no = b.orgmem_no ";
				sql += " where a.board_id = 'hongbo' AND a.topcompany = 'Y'";
				sql += " order by board_no";
				sql += " limit " + strlimit +", " + endlimit;
			break;
			}
			var count_sql = " select count(*) as cnt \n" +
			" from  hongbo_board \n" +
			" where 1=1 \n";
		
			db.query(count_sql, function(error, count_result){
				db.query(sql, function(error, results){
					if(error){
						response.send(error);
					}else{
						console.log(sql);
						response.send({
							connectorNo : connectorNo,
							db_data : results,
							db_data_length : count_result[0].cnt,
							active:active,
							/*page_navi :page_txt,*/
							/*nowPage : nowPage,*/
							menuNum:5
						});
					}
				});
			});
		/*});
	}); */
};
