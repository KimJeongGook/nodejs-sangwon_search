var nodeExcel = require('excel-export');

var db = require("../../DB_config.js").connect;

exports.listener=function(request, response){
	console.log("********************* excel_download_2.js enter *********************");
	var sql = "";	
	
    var conf ={};
    
	//a=[i+1, mem_name, mem_phone, mem_position, mem_birth, mem_join, mem_ness_name, mem_ness_phone, mem_work_duty, mem_work_phone, mem_address_work, mem_home_phone, mem_address_home];
    conf.cols = [{
        caption:'번호',
        type:'number',
        width:8
    },{
        caption:'지 역',
        captionStyleIndex: 1,        
        type:'string',
        beforeCellWrite:function(row, cellData){
                         if(cellData==null)
             return '';
            else
             return cellData.toUpperCase();
        }
        , width:15          
    },{
        caption:'회 장',
        captionStyleIndex: 1,        
        type:'string',
        beforeCellWrite:function(row, cellData){
                         if(cellData==null)
             return '';
            else
             return cellData.toUpperCase();
        }
        , width:15
    },{
        caption:'상근부회장',
        captionStyleIndex: 1,        
        type:'string',
        beforeCellWrite:function(row, cellData){
                         if(cellData==null)
             return '';
            else
             return cellData.toUpperCase();
        }
        , width:30    
    },{
        caption:'사무국장',
        captionStyleIndex: 1,        
        type:'string',
        beforeCellWrite:function(row, cellData){
                         if(cellData==null)
             return '';
            else
             return cellData.toUpperCase();
        }
        , width:30    
    },{
        caption:'주 소',
        captionStyleIndex: 1,        
        type:'string',
        beforeCellWrite:function(row, cellData){
                         if(cellData==null)
             return '';
            else
             return cellData.toUpperCase();
        }
        , width:60    
    },{   
        caption:'전화번호',
        captionStyleIndex: 1,        
        type:'string',
        beforeCellWrite:function(row, cellData){
                         if(cellData==null)
             return '';
            else
             return cellData.toUpperCase();
        }
        , width:15
    },{
        caption:'팩스번호',
        captionStyleIndex: 1,        
        type:'string',
        beforeCellWrite:function(row, cellData){
                         if(cellData==null)
             return '';
            else
             return cellData.toUpperCase();
        }
        , width:15         
    }];

    
    sql = "SELECT * FROM doc_2 ORDER BY idx \n";
	
	db.query(sql, function(error, results){
		 if(error){
			 //response.send(error);
		 }else{
			console.log("sql ::::::: " + sql);
			
			var arr = [];
			
			for(i=0; i<results.length; i++){
				var idx = results[i].idx;
                var area = results[i].area;                
                var chairman = results[i].chairman;
                var vice_chairman = results[i].vice_chairman;
                var secretary_general = results[i].secretary_general;
                var address = results[i].address;
                var company_phone = results[i].company_phone;
                var company_fax = results[i].company_fax;
                
				a=[idx, area, chairman, vice_chairman, secretary_general, address, company_phone, company_fax];
				
				arr.push(a);
			}
			
			conf.rows = arr;
			
			var result = nodeExcel.execute(conf);

		    response.setHeader('Content-Type', 'application/vnd.openxmlformats');

		    response.setHeader("Content-Disposition", "attachment; filename=" + "sheet2.xlsx");

		    response.end(result, 'binary');
		 }		 
		 
	});
}