var nodeExcel = require('excel-export');

var db = require("../../DB_config.js").connect;

exports.listener=function(request, response){
	console.log("********************* excel_download_11.js enter *********************");
	var sql = "";	
	
    var conf ={};
    
	//a=[i+1, mem_name, mem_phone, mem_position, mem_birth, mem_join, mem_ness_name, mem_ness_phone, mem_work_duty, mem_work_phone, mem_address_work, mem_home_phone, mem_address_home];
    conf.cols = [{
        caption:'번호',
        type:'number',
        width:8
    },{
        caption:'구분순번',
        captionStyleIndex: 1,        
        type:'string',
        beforeCellWrite:function(row, cellData){
                         if(cellData==null)
             return '';
            else
             return cellData.toUpperCase();
        }
        , width:15          
    },{
        caption:'구분',
        captionStyleIndex: 1,        
        type:'string',
        beforeCellWrite:function(row, cellData){
                         if(cellData==null)
             return '';
            else
             return cellData.toUpperCase();
        }
        , width:10
    },{
        caption:'회사명',
        captionStyleIndex: 1,        
        type:'string',
        beforeCellWrite:function(row, cellData){
                         if(cellData==null)
             return '';
            else
             return cellData.toUpperCase();
        }
        , width:30    
    },{
        caption:'홈페이지',
        captionStyleIndex: 1,        
        type:'string',
        beforeCellWrite:function(row, cellData){
                         if(cellData==null)
             return '';
            else
             return cellData.toUpperCase();
        }
        , width:30    
    },{
        caption:'대표자',
        captionStyleIndex: 1,        
        type:'string',
        beforeCellWrite:function(row, cellData){
                         if(cellData==null)
             return '';
            else
             return cellData.toUpperCase();
        }
        , width:30    
    },{   
        caption:'주 소',
        captionStyleIndex: 1,        
        type:'string',
        beforeCellWrite:function(row, cellData){
                         if(cellData==null)
             return '';
            else
             return cellData.toUpperCase();
        }
        , width:60
    },{
        caption:'전화번호',
        captionStyleIndex: 1,        
        type:'string',
        beforeCellWrite:function(row, cellData){
                         if(cellData==null)
             return '';
            else
             return cellData.toUpperCase();
        }
        , width:15         
    },{
        caption:'팩스번호',
        captionStyleIndex: 1,        
        type:'string',
        beforeCellWrite:function(row, cellData){
                         if(cellData==null)
             return '';
            else
             return cellData.toUpperCase();
        }
        , width:15         
    },{
        caption:'취급품목',
        captionStyleIndex: 1,        
        type:'string',
        beforeCellWrite:function(row, cellData){
                         if(cellData==null)
             return '';
            else
             return cellData.toUpperCase();
        }
        , width:70        
    },{
        caption:'매출액(백만원)',
        captionStyleIndex: 1,        
        type:'string',
        beforeCellWrite:function(row, cellData){
                         if(cellData==null)
             return '';
            else
             return cellData.toUpperCase();
        }
        , width:15         
    },{
        caption:'종업원수',
        captionStyleIndex: 1,        
        type:'string',
        beforeCellWrite:function(row, cellData){
                         if(cellData==null)
             return '';
            else
             return cellData.toUpperCase();
        }
        , width:15         
    },{
        caption:'설립년도',
        captionStyleIndex: 1,        
        type:'string',
        beforeCellWrite:function(row, cellData){
                         if(cellData==null)
             return '';
            else
             return cellData.toUpperCase();
        }
        , width:15         
    }];

    
    sql = "SELECT * FROM doc__11 ORDER BY idx \n";
	
	db.query(sql, function(error, results){
		 if(error){
			 //response.send(error);
		 }else{
			console.log("sql ::::::: " + sql);
			
			var arr = [];
			
			for(i=0; i<results.length; i++){
				var idx = results[i].idx;
                var order_num = results[i].order_num;                
                var division = results[i].division;
                var company_name = results[i].company_name;
                var homepage = results[i].homepage;
                var orgmem_name = results[i].orgmem_name;
                var address = results[i].address;
                var company_phone = results[i].company_phone;
                var company_fax = results[i].company_fax;
                var main_product = results[i].main_product;
                var sales = results[i].sales;
                var employee_num = results[i].employee_num;
                var year = results[i].year;
                
				a=[idx, order_num, division, company_name, homepage, orgmem_name, address, company_phone, company_fax, main_product, sales, employee_num, year];
				
				arr.push(a);
			}
			
			conf.rows = arr;
			
			var result = nodeExcel.execute(conf);

		    response.setHeader('Content-Type', 'application/vnd.openxmlformats');

		    response.setHeader("Content-Disposition", "attachment; filename=" + "sheet11.xlsx");

		    response.end(result, 'binary');
		 }		 
		 
	});
}